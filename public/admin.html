<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Timesheet Manager</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .navbar {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: var(--font-size-xl);
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: var(--spacing-md);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">Timesheet Manager - Admin</div>
            <div class="navbar-user">
                <span id="userName" class="text-secondary"></span>
                <button onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="alertContainer"></div>

        <div style="margin-bottom: var(--spacing-xl);">
            <h2>Admin Dashboard</h2>
            <p class="text-secondary">Manage users, tasks, and view team performance</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analytics', this)">Analytics</button>
            <button class="tab" onclick="switchTab('users', this)">Users</button>
            <button class="tab" onclick="switchTab('tasks', this)">Tasks</button>
            <button class="tab" onclick="switchTab('timesheets', this)">All Timesheets</button>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content active">
            <!-- Stats -->
            <div class="grid grid-4 mb-lg">
                <div class="stat-card">
                    <div class="stat-value" id="totalHours">0</div>
                    <div class="stat-label">Total Hours (All Employees)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEntries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeTasks">0</div>
                    <div class="stat-label">Active Tasks</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-2 mb-lg">
                <div class="glass-card">
                    <h3>Hours by Employee</h3>
                    <div class="chart-container">
                        <canvas id="employeeChart"></canvas>
                    </div>
                </div>
                <div class="glass-card">
                    <h3>Hours by Task</h3>
                    <div class="chart-container">
                        <canvas id="taskChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3>Daily Hours Trend (Last 14 Days)</h3>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content">
            <div class="glass-card mb-lg">
                <div class="flex justify-between items-center mb-md">
                    <h3>User Management</h3>
                    <button onclick="openModal('userModal')" class="btn btn-primary">Add User</button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasksTab" class="tab-content">
            <div class="glass-card mb-lg">
                <div class="flex justify-between items-center mb-md">
                    <h3>Task Management</h3>
                    <button onclick="openModal('taskModal')" class="btn btn-primary">Add Task</button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Task Name</th>
                                <th>Description</th>
                                <th>Estimated Hrs</th>
                                <th>Actual Hrs</th>
                                <th>Variance</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Timesheets Tab -->
        <div id="timesheetsTab" class="tab-content">
            <div class="glass-card">
                <h3>All Timesheet Entries</h3>

                <div class="grid grid-3 mb-md mt-md">
                    <div class="form-group">
                        <label class="form-label">Filter by Employee</label>
                        <select id="filterUser" class="form-select" onchange="loadTimesheets()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="filterStartDate" class="form-input" onchange="loadTimesheets()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="filterEndDate" class="form-input" onchange="loadTimesheets()">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Task</th>
                                <th>Hours</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timesheetsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle">Add User</h3>
            <form id="userForm">
                <input type="hidden" id="userId">

                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="userUsername" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="userFullName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="userPassword" class="form-input">
                    <small class="text-muted">Leave blank to keep current password when editing</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="userRole" class="form-select" required>
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="flex gap-md">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onclick="closeModal('userModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3 id="taskModalTitle">Add Task</h3>
            <form id="taskForm">
                <input type="hidden" id="taskId">

                <div class="form-group">
                    <label class="form-label">Task Name</label>
                    <input type="text" id="taskName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="taskDescription" class="form-input" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Estimated Hours</label>
                    <input type="number" id="taskEstimatedHours" class="form-input" min="0" step="0.5" placeholder="0">
                    <small class="text-muted">Planned hours for this task</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="taskStatus" class="form-select" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <div class="flex gap-md">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onclick="closeModal('taskModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;
        let users = [];
        let tasks = [];
        let timesheets = [];
        let employeeChart = null;
        let taskChart = null;
        let dailyChart = null;

        // Initialize
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) {
                window.location.href = '/';
                return;
            }

            if (currentUser.role !== 'admin') {
                window.location.href = '/dashboard';
                return;
            }

            document.getElementById('userName').textContent = currentUser.fullName;

            await loadUsers();
            await loadTasks();
            await loadAnalytics();
            await loadTimesheets();

            // Populate filter dropdown
            const filterSelect = document.getElementById('filterUser');
            users.filter(u => u.role === 'employee').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.full_name;
                filterSelect.appendChild(option);
            });
        }

        // Tab switching
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            element.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load users
        async function loadUsers() {
            try {
                users = await apiCall('/api/users');
                renderUsers();
            } catch (error) {
                showAlert('Failed to load users', 'error');
            }
        }

        // Load tasks
        async function loadTasks() {
            try {
                tasks = await apiCall('/api/tasks');
                renderTasks();
            } catch (error) {
                showAlert('Failed to load tasks', 'error');
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const analytics = await apiCall('/api/timesheet/analytics');

                // Update stats
                document.getElementById('totalHours').textContent = formatHours(analytics.summary.total_hours || 0);
                document.getElementById('totalEntries').textContent = analytics.summary.total_entries || 0;
                document.getElementById('totalEmployees').textContent = users.filter(u => u.role ===
                    'employee').length;
                document.getElementById('activeTasks').textContent = tasks.filter(t => t.status ===
                    'active').length;

                // Render charts
                renderEmployeeChart(analytics.hoursByUser);
                renderTaskChart(analytics.hoursByTask);
                renderDailyChart(analytics.hoursByDate);
            } catch (error) {
                showAlert('Failed to load analytics', 'error');
            }
        }

        // Load timesheets
        async function loadTimesheets() {
            try {
                const userId = document.getElementById('filterUser').value;
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;

                let url = '/api/timesheet?';
                if (userId) url += `userId=${userId}&`;
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}&`;

                timesheets = await apiCall(url);
                renderTimesheets();
            } catch (error) {
                showAlert('Failed to load timesheets', 'error');
            }
        }

        // Render users
        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.full_name}</td>
                        <td><span
                                class="badge badge-${user.role === 'admin' ? 'primary' : 'success'}">${user.role}</span>
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <button onclick='editUser(${JSON.stringify(user)})'
                                class="btn btn-secondary btn-sm">Edit</button>
                            <button onclick="deleteUser(${user.id})" class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                    `).join('');
        }

        // Render tasks
        function renderTasks() {
            const tbody = document.getElementById('tasksTableBody');

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No tasks</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                const estimated = parseFloat(task.estimated_hours) || 0;
                const actual = parseFloat(task.actual_hours) || 0;
                const variance = actual - estimated;
                const variancePercent = estimated > 0 ? ((variance / estimated) * 100).toFixed(1) : 0;

                // Color coding: green if under, red if over, gray if on track
                let varianceClass = 'text-secondary';
                let varianceIcon = '●';
                if (variance > 0) {
                    varianceClass = 'text-danger';  // Over estimated
                    varianceIcon = '▲';
                } else if (variance < 0) {
                    varianceClass = 'text-success';  // Under estimated
                    varianceIcon = '▼';
                }

                return `
                    <tr>
                        <td>${task.task_name}</td>
                        <td>${task.description || '-'}</td>
                        <td>${formatHours(estimated)} hrs</td>
                        <td>${formatHours(actual)} hrs</td>
                        <td class="${varianceClass}">
                            ${varianceIcon} ${formatHours(Math.abs(variance))} hrs
                            ${estimated > 0 ? `(${variancePercent > 0 ? '+' : ''}${variancePercent}%)` : ''}
                        </td>
                        <td><span class="badge badge-${task.status === 'active' ? 'success' : 'danger'}">${task.status}</span></td>
                        <td>${formatDate(task.created_at)}</td>
                        <td>
                            <button onclick='editTask(${JSON.stringify(task)})' class="btn btn-secondary btn-sm">Edit</button>
                            <button onclick="deleteTask(${task.id})" class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Render timesheets
        function renderTimesheets() {
            const tbody = document.getElementById('timesheetsTableBody');

            if (timesheets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No entries</td></tr>';
                return;
            }

            tbody.innerHTML = timesheets.map(entry => `
                    <tr>
                        <td>${entry.full_name}</td>
                        <td>${formatDate(entry.entry_date)}</td>
                        <td>${entry.task_name}</td>
                        <td>${formatHours(entry.hours_spent)} hrs</td>
                        <td>${entry.notes || '-'}</td>
                        <td>
                            <button onclick="deleteTimesheet(${entry.id})" class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                    `).join('');
        }

        // Render employee chart
        function renderEmployeeChart(data) {
            const ctx = document.getElementById('employeeChart');

            if (employeeChart) {
                employeeChart.destroy();
            }

            employeeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.full_name),
                    datasets: [{
                        label: 'Total Hours',
                        data: data.map(d => d.total_hours || 0),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Render task chart
        function renderTaskChart(data) {
            const ctx = document.getElementById('taskChart');

            if (taskChart) {
                taskChart.destroy();
            }

            taskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.task_name),
                    datasets: [{
                        data: data.map(d => d.total_hours),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(0, 242, 254, 0.8)',
                            'rgba(250, 112, 154, 0.8)',
                            'rgba(254, 225, 64, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'rgba(255, 255, 255, 0.7)' }
                        }
                    }
                }
            });
        }

        // Render daily chart
        function renderDailyChart(data) {
            const ctx = document.getElementById('dailyChart');

            if (dailyChart) {
                dailyChart.destroy();
            }

            // Get last 14 days
            const last14Days = [];
            for (let i = 13; i >= 0; i--) {
                last14Days.push(getDateDaysAgo(i));
            }

            const chartData = last14Days.map(date => {
                const entry = data.find(d => d.entry_date === date);
                return entry ? entry.total_hours : 0;
            });

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last14Days.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Total Hours',
                        data: chartData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // User form
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('userUsername').value,
                fullName: document.getElementById('userFullName').value,
                password: document.getElementById('userPassword').value,
                role: document.getElementById('userRole').value
            };

            try {
                if (id) {
                    await apiCall(`/api/users/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('User updated successfully!', 'success');
                } else {
                    await apiCall('/api/users', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('User created successfully!', 'success');
                }

                closeModal('userModal');
                e.target.reset();
                await loadUsers();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });

        // Task form
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('taskId').value;
            const data = {
                taskName: document.getElementById('taskName').value,
                description: document.getElementById('taskDescription').value,
                estimatedHours: parseFloat(document.getElementById('taskEstimatedHours').value) || 0,
                status: document.getElementById('taskStatus').value
            };

            try {
                if (id) {
                    await apiCall(`/api/tasks/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Task updated successfully!', 'success');
                } else {
                    await apiCall('/api/tasks', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Task created successfully!', 'success');
                }

                closeModal('taskModal');
                e.target.reset();
                await loadTasks();
                await loadAnalytics();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });

        // Edit user
        function editUser(user) {
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userFullName').value = user.full_name;
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role;
            openModal('userModal');
        }

        // Edit task
        function editTask(task) {
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskName').value = task.task_name;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskEstimatedHours').value = task.estimated_hours || 0;
            document.getElementById('taskStatus').value = task.status;
            openModal('taskModal');
        }

        // Delete user
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                await apiCall(`/api/users/${id}`, { method: 'DELETE' });
                showAlert('User deleted successfully!', 'success');
                await loadUsers();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Delete task
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                await apiCall(`/api/tasks/${id}`, { method: 'DELETE' });
                showAlert('Task deleted successfully!', 'success');
                await loadTasks();
                await loadAnalytics();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Delete timesheet
        async function deleteTimesheet(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;

            try {
                await apiCall(`/api/timesheet/${id}`, { method: 'DELETE' });
                showAlert('Entry deleted successfully!', 'success');
                await loadTimesheets();
                await loadAnalytics();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Reset modals when closed
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        init();
    </script>
</body>

</html>